!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedChangeFromBaseline=n()}(this,(function(){"use strict";var t={addElement:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(t,n){return n};return e?n.selectAll("".concat(i,".acfb-").concat(t,".acfb-").concat(i)).data(e,s).join(i).classed("acfb-".concat(t," acfb-").concat(i),!0):n.append(i).classed("acfb-".concat(t," acfb-").concat(i),!0)}};function n(t,n,i){return n in t?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i,t}function i(t,n){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var e=Object.getOwnPropertySymbols(t);n&&(e=e.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),i.push.apply(i,e)}return i}function e(t){return function(t){if(Array.isArray(t))return r(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||s(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,n){if(t){if("string"==typeof t)return r(t,n);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(t,n):void 0}}function r(t,n){(null==n||n>t.length)&&(n=t.length);for(var i=0,e=new Array(n);i<n;i++)e[i]=t[i];return e}function a(t,n){var i;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=s(t))||n&&t&&"number"==typeof t.length){i&&(t=i);var e=0,r=function(){};return{s:r,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,u=!1;return{s:function(){i=t[Symbol.iterator]()},n:function(){var t=i.next();return o=t.done,t},e:function(t){u=!0,a=t},f:function(){try{o||null==i.return||i.return()}finally{if(u)throw a}}}}function o(t){this.settings.width=(this.settings.width||t.node().clientWidth)-this.settings.margin.left-this.settings.margin.right,this.settings.height=(this.settings.height||2*t.node().clientHeight/3)-this.settings.margin.top-this.settings.margin.bottom}function u(){var t=this.set.visit[this.settings.timepoint];function n(t){d3.select(this).transition().duration(t/8).delay(t-t/8*2).style("opacity",0)}return this.layout.timepoint.text(t).call((function(t,i){t.style("opacity",0).transition().duration(i/8).style("opacity",1).on("end",(function(){n.call(this,i)}))}),this.settings.speed),t}function c(){var t=this;this.measure_id=this.group.measure_id.find((function(n){return n[0]===t.measure}))[1].filter((function(n){return n.datum=n[1].find((function(n){return n.visit===t.timepoint})),void 0!==n.datum})),this.measure_id.forEach((function(n){n.stratum=n[1][0].stratum,n.result=n.datum?n.datum.result:null,n.chg=n.datum?n.datum.chg:null,n.change=n.chg,n.pchg=n.datum?n.datum.pchg:null,n.percent_change=n.pchg,n.tooltip=n.datum?["id","stratum","visit","measure","result","chg","pchg"].map((function(i){return"".concat(t.settings.var_labels[i],": ").concat(n.datum[i])})).join("\n"):null}))}function l(t,n,i){t.classList.toggle("acfb-hovered")}function h(t,n,i){t.classList.toggle("acfb-clicked")}function d(t,n,i){t.classList.toggle("acfb-hovered")}function f(){var t=this,n=this;c.call(this);var i=this.util.addElement("node",this.layout.bubbles,"circle",this.measure_id,(function(t){return t[1]})).attr("r",this.settings.radius).attr("fill",(function(n){return t.scale.color(n.stratum)})).attr("stroke",(function(n){return t.scale.color(n.stratum)}));return i.append("title").text((function(t){return t.tooltip})),i.on("mouseover",(function(t,i){l.call(n,this,t,i)})),i.on("click",(function(t,i){h.call(n,this,t,i)})),i.on("mouseout",(function(t,i){d.call(n,this,t,i)})),i}function m(){var t=this;this.simulation.alpha(1).force("x",d3.forceX((function(n){return t.scale.x(n[t.settings.outcome])}))).force("y",d3.forceY((function(n){return t.scale.y(n.stratum)+t.scale.y.bandwidth()/2}))).restart()}function g(){var t=this;this.distribution.binGenerator=d3.bin().domain(this.scale.x.domain()).thresholds(this.scale.x.ticks(20)),this.distribution.rollups=d3.rollups(this.measure_id,(function(n){var i=n.map((function(n){return n[t.settings.outcome]}));return t.distribution.binGenerator(i)}),(function(t){return t.stratum})).sort((function(t,n){return t[0]<n[0]?-1:1})),this.distribution.rollups.forEach((function(t){t[1].stratum=t[0]})),this.distribution.nBins=d3.max(this.distribution.rollups,(function(t){return d3.max(t[1],(function(t){return t.length}))})),this.distribution.binScale.domain([-this.distribution.nBins,this.distribution.nBins]),this.distribution.violins.data(this.distribution.rollups,(function(t){return t[0]})),this.distribution.violins.select("path").datum((function(t){return t[1]})).transition().duration(this.settings.speed/4).attr("d",d3.area().x((function(n){return t.scale.x(n.x0)})).y0((function(n){return t.distribution.binScale(-n.length)})).y1((function(n){return t.distribution.binScale(n.length)})).curve(d3.curveCatmullRom))}function p(){var t=this;this.settings.timepoint++,this.settings.timepoint>=this.set.visit.length&&(this.settings.timepoint=0),this.timepoint=u.call(this),this.nodes=f.call(this),this.layout.yAxis.selectAll("tspan.acfb-stratum-count").text((function(n){return"n=".concat(t.measure_id.filter((function(t){return t.stratum===n})).length)})),m.call(this),g.call(this)}function b(){var t=this;return d3.interval((function(){p.call(t)}),this.settings.speed)}function v(t){var n=this,i=this.util.addElement("play",t),e=this.util.addElement("button",i,"button").text(this.settings.play?"pause":"play");return e.on("click",(function(t,i){n.settings.play=!n.settings.play,d3.select(this).text(n.settings.play?"pause":"play"),n.settings.play?n.interval=b.call(n):n.interval.stop()})),{div:i,button:e}}function y(t){var n=this,i=this.util.addElement("step",t),e=this.util.addElement("button",i,"button",["<",">"]).text((function(t){return t}));return e.on("click",(function(t,i){n.settings.play=!1,n.controls.play.button.text("play"),n.interval&&n.interval.stop(),"<"===this.textContent&&(n.settings.timepoint=0===n.settings.timepoint?n.set.visit.length-2:n.settings.timepoint-2),p.call(n)})),{div:i,buttons:e}}function x(){var t=this.layout.xAxis.call(d3.axisTop(this.scale.x).tickSize(-this.settings.height)).call((function(t){return t.selectAll(".tick line").attr("stroke-opacity",.5).attr("stroke-dasharray","2,2")}));return this.layout.xAxis.append("text").classed("achb-axis-label achb-axis-label--x",!0).attr("text-anchor","middle").attr("x",this.settings.width/2).attr("y",-this.settings.margin.top/2).style("font-size","1.5rem").style("fill","black").text(this.measure),t}function _(t){var n=this,i=this,e=this.util.addElement("outcome",t),s=this.util.addElement("button",e,"button",["result","change","percent_change"].map((function(t){return{variable:t,label:n.settings.var_labels[t]}}))).classed("acfb-active",(function(t){return t.variable===n.settings.outcome})).text((function(t){return t.label}));return s.on("click",(function(t,n){this.classList.contains("acfb-active")||(s.classed("acfb-active",!1),this.classList.toggle("acfb-active"),i.settings.outcome=n.variable,i.scale.x=i.scale[i.settings.outcome],i.xAxis=x.call(i),m.call(i),g.call(i))})),{div:e,buttons:s}}function w(t){var n=this.util.addElement("controls",t);return this.controls={play:v.call(this,n),step:y.call(this,n),outcome:_.call(this,n)},n}function A(t){var n=this.util.addElement("svg",t,"svg").attr("width",this.settings.width+this.settings.margin.left+this.settings.margin.right).attr("height",this.settings.height+this.settings.margin.top+this.settings.margin.bottom),i=this.util.addElement("canvas",n,"g").attr("transform","translate(".concat(this.settings.margin.left,",").concat(this.settings.margin.top,")"));return{svg:n,canvas:i,timepoint:this.util.addElement("timepoint",i,"text").attr("y",-this.settings.margin.top/2),xAxis:this.util.addElement("x-axis",i,"g"),yAxis:this.util.addElement("y-axis",i,"g"),violins:this.util.addElement("violins",i,"g"),bubbles:this.util.addElement("bubbles",i,"g")}}function E(){var t=this.util.addElement("main",d3.select(this.element));return o.call(this,t),function(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?i(Object(s),!0).forEach((function(i){n(t,i,s[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):i(Object(s)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(s,n))}))}return t}({main:t,controls:w.call(this,t)},A.call(this,t))}function O(){var t,n={},i=a(Object.keys(this.settings).filter((function(t){return/_var$/.test(t)})));try{for(i.s();!(t=i.n()).done;){var e=t.value;n[e.replace(/_var$/,"")]=this.data[0].hasOwnProperty(this.settings[e])}}catch(t){i.e(t)}finally{i.f()}return n}function S(){var t=this;this.data.forEach((function(n){var i,e=a(Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})));try{for(e.s();!(i=e.n()).done;){var s=i.value,r=s.replace(/_var$/,"");n[r]=["visit_order","result","change"].includes(r)?parseFloat(n[t.settings[s]]):n[t.settings[s]]}}catch(t){e.e(t)}finally{e.f()}}))}function j(){d3.rollup(this.data,(function(t){t.sort((function(t,n){t.visit_order,n.visit_order})),t.baseline=t[0],t.forEach((function(n){n.baseline=t.baseline.result,n.chg=n.result-n.baseline,n.change=n.chg,n.pchg=0!==n.baseline?n.chg/n.baseline*100:NaN,n.percent_change=n.pchg}))}),(function(t){return t.measure}),(function(t){return t.id}))}function k(){}function C(){var t=O.call(this);S.call(this),j.call(this,t),k.call(this)}function P(t){var n;switch(t){case"visit":n=e(new Set(this.data.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,n){return t.replace(/.*\|/,"")-n.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:n=e(new Set(this.data.map((function(n){return n[t]}))).values()).sort()}return n}function I(){var t={};return t.id=P.call(this,"id"),t.stratum=P.call(this,"stratum"),t.visit=P.call(this,"visit"),t.measure=P.call(this,"measure"),t}function L(t){var n;switch(t){case"measure,id":n=d3.groups(this.data,(function(t){return t.measure}),(function(t){return t.id}));break;default:n=d3.group(this.data,(function(n){return n[t]}))}return n}function M(){var t={};return t.id=L.call(this,"id"),t.stratum=L.call(this,"stratum"),t.visit=L.call(this,"visit"),t.measure=L.call(this,"measure"),t.measure_id=L.call(this,"measure,id"),t}function T(){C.call(this),this.set=I.call(this),this.group=M.call(this)}function B(){return d3.scaleLinear().nice().domain(d3.extent(this.subset,(function(t){return t.result}))).range([0,this.settings.width])}function D(){var t=d3.max(this.subset,(function(t){return Math.abs(t.change)}));return d3.scaleLinear().nice().domain([-t,t]).range([0,this.settings.width])}function $(){var t=d3.max(this.subset,(function(t){return Math.abs(t.percent_change)}));return d3.scaleLinear().nice().domain([-t,t]).range([0,this.settings.width])}function G(){return d3.scaleBand().domain(this.set.stratum).range([this.settings.height,0])}function R(){return d3.scaleOrdinal().domain(this.set.stratum).range(d3.schemeCategory10)}function V(){var t={};return t.result=B.call(this),t.change=D.call(this),t.percent_change=$.call(this),t.x=t[this.settings.outcome],t.y=G.call(this),t.color=R.call(this),t}function F(){var t=this;return this.layout.yAxis.call(d3.axisLeft(this.scale.y)).call((function(n){var i=n.selectAll(".tick text");i.text(null),i.append("tspan").classed("acfb-stratum-label",!0).attr("x",-9).attr("text-anchor","end").text((function(t){return t})),i.append("tspan").classed("acfb-stratum-count",!0).attr("x",-9).attr("text-anchor","end").attr("dy",15).text((function(n){return"n=".concat(new Set(t.group.stratum.get(n).map((function(t){return t.id}))).size)}))}))}function z(){this.nodes.attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y}))}function H(){var t=this;return d3.forceSimulation().nodes(this.measure_id).force("x",d3.forceX((function(n){return t.scale.x(n[t.settings.outcome])}))).force("y",d3.forceY((function(n){return t.scale.y(n.stratum)+t.scale.y.bandwidth()/2}))).force("collide",d3.forceCollide().radius(this.settings.radius+1)).on("tick",z.bind(this))}function N(){var t=this,n=d3.bin().domain(this.scale.x.domain()).thresholds(this.scale.x.ticks(20)),i=d3.rollups(this.measure_id,(function(i){var e=i.map((function(n){return n[t.settings.outcome]}));return n(e)}),(function(t){return t.stratum})).sort((function(t,n){return t[0]<n[0]?-1:1}));i.forEach((function(t){t[1].stratum=t[0]}));var e=d3.max(i,(function(t){return d3.max(t[1],(function(t){return t.length}))})),s=d3.scaleLinear().range([0,this.scale.y.bandwidth()]).domain([-e,e]),r=this.util.addElement("violin",this.layout.violins,"g",i,(function(t){return t[0]})).attr("transform",(function(n){return"translate(0,".concat(t.scale.y(n[0]),")")}));return r.append("path").datum((function(t){return t[1]})).style("fill",(function(n){return t.scale.color(n.stratum)})).style("fill-opacity",.25).style("stroke","none").attr("d",d3.area().x((function(n){return t.scale.x(n.x0)})).y0((function(t){return s(-t.length)})).y1((function(t){return s(t.length)})).curve(d3.curveCatmullRom)),{binGenerator:n,rollups:i,binScale:s,violins:r}}function U(){var t=this;this.measure=this.set.measure[Math.floor(Math.random()*this.set.measure.length)],this.measure_id=this.group.measure_id.find((function(n){return n[0]===t.measure}))[1],this.subset=this.data.filter((function(n){return n.measure===t.measure})),this.scale=V.call(this),this.xAxis=x.call(this),this.yAxis=F.call(this),this.timepoint=u.call(this),this.nodes=f.call(this),this.simulation=H.call(this),this.distribution=N.call(this),this.settings.play&&(this.interval=b.call(this))}return function(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={data:n,element:i,settings:Object.assign({id_var:"USUBJID",stratum_var:"ARM",strata:null,visit_var:"AVISIT",visit_order_var:"AVISITN",measure_var:"PARAM",result_var:"AVAL",change_var:"CHG",percent_change_var:"PCHG",outcome:"change",var_labels:{id:"Participant ID",stratum:"Stratum",visit:"Visit",visit_order:"Visit Order",measure:"Measure",result:"Result",change:"Change",chg:"Change",percent_change:"% Change",pchg:"% Change",fold_change:"Fold Change",fchg:"Fold Change"},timepoint:0,speed:5e3,play:!0,shape:"circle",radius:5,width:null,height:null,margin:{top:69,right:10,bottom:10,left:90}},e),util:t};return s.layout=E.call(s),T.call(s),U.call(s),s}}));
