!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).animatedChangeFromBaseline=i()}(this,(function(){"use strict";var t={addElement:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"div",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return e?i.selectAll("".concat(n,".acfb-").concat(t,".acfb-").concat(n)).data(e).join(n).classed("acfb-".concat(t," acfb-").concat(n),!0):i.append(n).classed("acfb-".concat(t," acfb-").concat(n),!0)}};function i(t,i,n){return i in t?Object.defineProperty(t,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[i]=n,t}function n(t,i){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var e=Object.getOwnPropertySymbols(t);i&&(e=e.filter((function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable}))),n.push.apply(n,e)}return n}function e(t){return function(t){if(Array.isArray(t))return s(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||r(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(t,i){if(t){if("string"==typeof t)return s(t,i);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?s(t,i):void 0}}function s(t,i){(null==i||i>t.length)&&(i=t.length);for(var n=0,e=new Array(i);n<i;n++)e[n]=t[n];return e}function a(t,i){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=r(t))||i&&t&&"number"==typeof t.length){n&&(t=n);var e=0,s=function(){};return{s:s,n:function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,l=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){l=!0,a=t},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw a}}}}function o(t){this.settings.width=(this.settings.width||t.node().clientWidth)-this.settings.margin.left-this.settings.margin.right,this.settings.height=(this.settings.height||2*t.node().clientHeight/3)-this.settings.margin.top-this.settings.margin.bottom}function l(){var t=this.set.visit[this.settings.timepoint];return this.layout.timepoint.text(t),t}function u(){var t=this;this.measure_id.forEach((function(i){i.stratum=i[1][0].stratum,i.datum=i[1].find((function(i){return i.visit===t.timepoint})),i.chg=i.datum?i.datum.chg:null}))}function c(){var t=this;this.simulation.alpha(1).force("x",d3.forceX((function(i){return t.scale.x(i.chg)}))).force("y",d3.forceY((function(i){return t.scale.y(i.stratum)+t.scale.y.bandwidth()/2}))).restart()}function h(){var t=this;this.distribution.summary=d3.rollups(this.measure_id,(function(i){var n=i.map((function(t){return t.chg}));return t.distribution.histogram(n)}),(function(t){return t.stratum})),this.distribution.nBins=d3.max(this.distribution.summary,(function(t){return d3.max(t[1],(function(t){return t.length}))})),this.distribution.scale.domain([-this.distribution.nBins,this.distribution.nBins]),this.distribution.g.data(this.distribution.summary),this.distribution.path.attr("d",d3.area().x((function(t){return t.x0})).y0((function(i){return t.distribution.scale(-i.length)})).y1((function(i){return t.distribution.scale(i.length)})).curve(d3.curveCatmullRom))}function d(){this.settings.timepoint++,this.settings.timepoint>=this.set.visit.length&&(this.settings.timepoint=0),this.timepoint=l.call(this),u.call(this),c.call(this),h.call(this)}function f(){var t=this;return d3.interval((function(){d.call(t)}),this.settings.speed)}function m(t){var i=this,n=this.util.addElement("play",t),e=this.util.addElement("button",n,"button").text(this.settings.play?"pause":"play");return e.on("click",(function(){i.settings.play=!i.settings.play,d3.select(this).text(i.settings.play?"pause":"play"),i.settings.play?i.interval=f.call(i):i.interval.stop()})),{div:n,button:e}}function g(t){var i=this,n=this.util.addElement("step",t),e=this.util.addElement("button",n,"button",["<",">"]).text((function(t){return t}));return e.on("click",(function(){i.settings.play=!1,i.controls.play.button.text("play"),i.interval&&i.interval.stop(),"<"===this.textContent&&(i.settings.timepoint=0===i.settings.timepoint?i.set.visit.length-2:i.settings.timepoint-2),d.call(i)})),{div:n,buttons:e}}function p(t){var i=this.util.addElement("controls",t);return this.controls={play:m.call(this,i),step:g.call(this,i)},i}function v(t){var i=this.util.addElement("svg",t,"svg").attr("width",this.settings.width+this.settings.margin.left+this.settings.margin.right).attr("height",this.settings.height+this.settings.margin.top+this.settings.margin.bottom),n=this.util.addElement("canvas",i,"g").attr("transform","translate(".concat(this.settings.margin.left,",").concat(this.settings.margin.top,")"));return{svg:i,canvas:n,timepoint:this.util.addElement("timepoint",n,"text").attr("y",-this.settings.margin.top/2),xAxis:this.util.addElement("x-axis",n,"g"),yAxis:this.util.addElement("y-axis",n,"g"),bubbles:this.util.addElement("bubbles",n,"g"),violins:this.util.addElement("violins",n,"g")}}function y(){var t=this.util.addElement("main",d3.select(this.element));return o.call(this,t),function(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?n(Object(r),!0).forEach((function(n){i(t,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(r,i))}))}return t}({main:t,controls:p.call(this,t)},v.call(this,t))}function b(){var t,i={},n=a(Object.keys(this.settings).filter((function(t){return/_var$/.test(t)})));try{for(n.s();!(t=n.n()).done;){var e=t.value;i[e.replace(/_var$/,"")]=this.data[0].hasOwnProperty(this.settings[e])}}catch(t){n.e(t)}finally{n.f()}return i}function x(){var t=this;this.data.forEach((function(i){var n,e=a(Object.keys(t.settings).filter((function(t){return/_var$/.test(t)})));try{for(e.s();!(n=e.n()).done;){var r=n.value,s=r.replace(/_var$/,"");i[s]=["visit_order","result","change"].includes(s)?parseFloat(i[t.settings[r]]):i[t.settings[r]]}}catch(t){e.e(t)}finally{e.f()}}))}function w(){d3.rollup(this.data,(function(t){t.sort((function(t,i){t.visit_order,i.visit_order})),t.baseline=t[0],t.forEach((function(i){i.baseline=t.baseline.result,i.chg=i.result-i.baseline,i.fchg=i.chg/i.baseline,i.pchg=100*i.fchg}))}),(function(t){return t.measure}),(function(t){return t.id}))}function A(){}function _(){var t=b.call(this);x.call(this),w.call(this,t),A.call(this)}function O(t){var i;switch(t){case"visit":i=e(new Set(this.data.filter((function(t){return!(t.visit_order%1)})).map((function(t){return t.visit+"|"+t.visit_order}))).values()).sort((function(t,i){return t.replace(/.*\|/,"")-i.replace(/.*\|/,"")})).map((function(t){return t.replace(/\|.*$/,"")}));break;default:i=e(new Set(this.data.map((function(i){return i[t]}))).values()).sort()}return i}function j(){var t={};return t.id=O.call(this,"id"),t.stratum=O.call(this,"stratum"),t.visit=O.call(this,"visit"),t.measure=O.call(this,"measure"),t}function E(t){var i;switch(t){case"measure,id":i=d3.groups(this.data,(function(t){return t.measure}),(function(t){return t.id}));break;default:i=d3.group(this.data,(function(i){return i[t]}))}return i}function S(){var t={};return t.id=E.call(this,"id"),t.stratum=E.call(this,"stratum"),t.visit=E.call(this,"visit"),t.measure=E.call(this,"measure"),t.measure_id=E.call(this,"measure,id"),t}function k(){_.call(this),this.set=j.call(this),this.group=S.call(this)}function P(){var t=d3.max(this.subset,(function(t){return Math.abs(t.change)}));return d3.scaleLinear().nice().domain([-t,t]).range([0,this.settings.width])}function I(){return d3.scaleBand().domain(this.set.stratum).range([this.settings.height,0])}function C(){return d3.scaleOrdinal().domain(this.set.stratum).range(d3.schemeCategory10)}function T(){var t={};return t.x=P.call(this),t.y=I.call(this),t.color=C.call(this),t}function B(){var t=this.layout.xAxis.call(d3.axisTop(this.scale.x).tickSize(-this.settings.height)).call((function(t){return t.selectAll(".tick line").attr("stroke-opacity",.5).attr("stroke-dasharray","2,2")}));return this.layout.xAxis.append("text").classed("achb-axis-label achb-axis-label--x",!0).attr("text-anchor","middle").attr("x",this.settings.width/2).attr("y",-this.settings.margin.top/2).style("font-size","1.5rem").style("fill","black").text(this.measure),t}function M(){var t=this;return this.layout.yAxis.call(d3.axisLeft(this.scale.y)).call((function(i){var n=i.selectAll(".tick text");n.text(null),n.append("tspan").attr("x",-9).attr("text-anchor","end").text((function(t){return t})),n.append("tspan").attr("x",-9).attr("text-anchor","end").attr("dy",15).text((function(i){return"n=".concat(new Set(t.group.stratum.get(i).map((function(t){return t.id}))).size)}))}))}function $(){var t=this;return u.call(this),this.layout.bubbles.selectAll("circle").data(this.measure_id,(function(t){return t[1]})).join("circle").attr("r",this.settings.radius).attr("fill",(function(i){return t.scale.color(i.stratum)})).attr("fill-opacity",.5).attr("stroke",(function(i){return t.scale.color(i.stratum)})).attr("stroke-opacity",1)}function D(){this.nodes.attr("cx",(function(t){return t.x})).attr("cy",(function(t){return t.y}))}function L(){var t=this;return d3.forceSimulation().nodes(this.measure_id).force("x",d3.forceX((function(i){return t.scale.x(i.chg)}))).force("y",d3.forceY((function(i){return t.scale.y(i.stratum)+t.scale.y.bandwidth()/2}))).force("collide",d3.forceCollide().radius(this.settings.radius+1)).on("tick",D.bind(this))}function R(){var t=this,i=d3.bin().domain(this.scale.x.domain()).thresholds(this.scale.x.ticks(20)),n=d3.rollups(this.measure_id,(function(t){var n=t.map((function(t){return t.chg}));return i(n)}),(function(t){return t.stratum})),e=d3.max(n,(function(t){return d3.max(t[1],(function(t){return t.length}))})),r=d3.scaleLinear().range([0,this.scale.y.bandwidth()]).domain([-e,e]),s=this.util.addElement("violin",this.layout.canvas,"g",n).attr("transform",(function(i){return"translate(0,".concat(t.scale.y(i[0]),")")})).append("path").datum((function(t){return t[1]})).style("stroke","none").style("fill","#69b3a2").attr("d",d3.area().x((function(i){return console.log(i.x0),t.scale.x(i.x0)})).y0((function(t){return r(-t.length)})).y1((function(t){return r(t.length)})).curve(d3.curveCatmullRom));return console.log(s.node()),{binGenerator:i,rollups:n,binScale:r,violins:s}}function z(){var t=this;this.measure=this.set.measure[Math.floor(Math.random()*this.set.measure.length)],this.measure_id=this.group.measure_id.find((function(i){return i[0]===t.measure}))[1],this.subset=this.data.filter((function(i){return i.measure===t.measure})),this.scale=T.call(this),this.xAxis=B.call(this),this.yAxis=M.call(this),this.timepoint=l.call(this),this.nodes=$.call(this),this.simulation=L.call(this),this.distribution=R.call(this),this.settings.play&&(this.interval=f.call(this))}return function(i){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"body",e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={data:i,element:n,settings:Object.assign({id_var:"USUBJID",stratum_var:"ARM",visit_var:"AVISIT",visit_order_var:"AVISITN",measure_var:"PARAM",result_var:"AVAL",change_var:"CHG",percent_change_var:"PCHG",timepoint:0,speed:5e3,play:!0,shape:"circle",radius:10,width:null,height:null,margin:{top:69,right:10,bottom:10,left:90}},e),util:t};return r.layout=y.call(r),k.call(r),z.call(r),r}}));
